// Copyright 2018-2025 the oak authors. All rights reserved. MIT license.
import { createPromiseWithResolvers } from "./utils/create_promise_with_resolvers.ts";
// deno-lint-ignore no-explicit-any
export const DomResponse = globalThis.Response ?? class MockResponse {
};
const maybeUpgradeWebSocket = "Deno" in globalThis && "upgradeWebSocket" in globalThis.Deno ? Deno.upgradeWebSocket.bind(Deno) : undefined;
export function isNativeRequest(r) {
  return r instanceof NativeRequest;
}
/** An internal oak abstraction for handling a Deno native request. Most users
 * of oak do not need to worry about this abstraction. */ export class NativeRequest {
  #remoteAddr;
  // deno-lint-ignore no-explicit-any
  #reject;
  #request;
  #resolve;
  #resolved = false;
  #response;
  #upgradeWebSocket;
  constructor(request, info){
    this.#remoteAddr = info.remoteAddr;
    // this allows for the value to be explicitly undefined in the options
    this.#upgradeWebSocket = "upgradeWebSocket" in info ? info.upgradeWebSocket : maybeUpgradeWebSocket;
    this.#request = request;
    const { resolve, reject, promise } = createPromiseWithResolvers();
    this.#resolve = resolve;
    this.#reject = reject;
    this.#response = promise;
  }
  get body() {
    return this.#request.body;
  }
  get headers() {
    return this.#request.headers;
  }
  get method() {
    return this.#request.method;
  }
  get remoteAddr() {
    return this.#remoteAddr?.hostname;
  }
  get request() {
    return this.#request;
  }
  get response() {
    return this.#response;
  }
  get url() {
    try {
      const url = new URL(this.#request.url);
      return this.#request.url.replace(url.origin, "");
    } catch  {
    // we don't care about errors, we just want to fall back
    }
    return this.#request.url;
  }
  get rawUrl() {
    return this.#request.url;
  }
  // deno-lint-ignore no-explicit-any
  error(reason) {
    if (this.#resolved) {
      throw new Error("Request already responded to.");
    }
    this.#reject(reason);
    this.#resolved = true;
  }
  getBody() {
    return this.#request.body;
  }
  respond(response) {
    if (this.#resolved) {
      throw new Error("Request already responded to.");
    }
    this.#resolved = true;
    this.#resolve(response);
  }
  upgrade(options) {
    if (this.#resolved) {
      throw new Error("Request already responded to.");
    }
    if (!this.#upgradeWebSocket) {
      throw new TypeError("Upgrading web sockets not supported.");
    }
    const { response, socket } = this.#upgradeWebSocket(this.#request, options);
    this.#resolve(response);
    this.#resolved = true;
    return socket;
  }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvb2FrQHYxNy4xLjYvaHR0cF9zZXJ2ZXJfbmF0aXZlX3JlcXVlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IDIwMTgtMjAyNSB0aGUgb2FrIGF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuIE1JVCBsaWNlbnNlLlxuXG5pbXBvcnQgdHlwZSB7XG4gIE5ldEFkZHIsXG4gIFNlcnZlclJlcXVlc3QsXG4gIFVwZ3JhZGVXZWJTb2NrZXRGbixcbiAgVXBncmFkZVdlYlNvY2tldE9wdGlvbnMsXG59IGZyb20gXCIuL3R5cGVzLnRzXCI7XG5pbXBvcnQgeyBjcmVhdGVQcm9taXNlV2l0aFJlc29sdmVycyB9IGZyb20gXCIuL3V0aWxzL2NyZWF0ZV9wcm9taXNlX3dpdGhfcmVzb2x2ZXJzLnRzXCI7XG5cbi8vIGRlbm8tbGludC1pZ25vcmUgbm8tZXhwbGljaXQtYW55XG5leHBvcnQgY29uc3QgRG9tUmVzcG9uc2U6IHR5cGVvZiBSZXNwb25zZSA9IChnbG9iYWxUaGlzIGFzIGFueSkuUmVzcG9uc2UgPz9cbiAgY2xhc3MgTW9ja1Jlc3BvbnNlIHt9O1xuXG5jb25zdCBtYXliZVVwZ3JhZGVXZWJTb2NrZXQ6IFVwZ3JhZGVXZWJTb2NrZXRGbiB8IHVuZGVmaW5lZCA9XG4gIFwiRGVub1wiIGluIGdsb2JhbFRoaXMgJiYgXCJ1cGdyYWRlV2ViU29ja2V0XCIgaW4gZ2xvYmFsVGhpcy5EZW5vXG4gICAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgICA/IChEZW5vIGFzIGFueSkudXBncmFkZVdlYlNvY2tldC5iaW5kKERlbm8pXG4gICAgOiB1bmRlZmluZWQ7XG5cbmV4cG9ydCBmdW5jdGlvbiBpc05hdGl2ZVJlcXVlc3QocjogU2VydmVyUmVxdWVzdCk6IHIgaXMgTmF0aXZlUmVxdWVzdCB7XG4gIHJldHVybiByIGluc3RhbmNlb2YgTmF0aXZlUmVxdWVzdDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBOYXRpdmVSZXF1ZXN0SW5mbyB7XG4gIHJlbW90ZUFkZHI/OiBOZXRBZGRyO1xuICB1cGdyYWRlV2ViU29ja2V0PzogVXBncmFkZVdlYlNvY2tldEZuO1xufVxuXG4vKiogQW4gaW50ZXJuYWwgb2FrIGFic3RyYWN0aW9uIGZvciBoYW5kbGluZyBhIERlbm8gbmF0aXZlIHJlcXVlc3QuIE1vc3QgdXNlcnNcbiAqIG9mIG9hayBkbyBub3QgbmVlZCB0byB3b3JyeSBhYm91dCB0aGlzIGFic3RyYWN0aW9uLiAqL1xuZXhwb3J0IGNsYXNzIE5hdGl2ZVJlcXVlc3QgaW1wbGVtZW50cyBTZXJ2ZXJSZXF1ZXN0IHtcbiAgI3JlbW90ZUFkZHI/OiBOZXRBZGRyO1xuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICAjcmVqZWN0OiAocmVhc29uPzogYW55KSA9PiB2b2lkO1xuICAjcmVxdWVzdDogUmVxdWVzdDtcbiAgI3Jlc29sdmU6ICh2YWx1ZTogUmVzcG9uc2UpID0+IHZvaWQ7XG4gICNyZXNvbHZlZCA9IGZhbHNlO1xuICAjcmVzcG9uc2U6IFByb21pc2U8UmVzcG9uc2U+O1xuICAjdXBncmFkZVdlYlNvY2tldD86IFVwZ3JhZGVXZWJTb2NrZXRGbjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICByZXF1ZXN0OiBSZXF1ZXN0LFxuICAgIGluZm86IE5hdGl2ZVJlcXVlc3RJbmZvLFxuICApIHtcbiAgICB0aGlzLiNyZW1vdGVBZGRyID0gaW5mby5yZW1vdGVBZGRyO1xuICAgIC8vIHRoaXMgYWxsb3dzIGZvciB0aGUgdmFsdWUgdG8gYmUgZXhwbGljaXRseSB1bmRlZmluZWQgaW4gdGhlIG9wdGlvbnNcbiAgICB0aGlzLiN1cGdyYWRlV2ViU29ja2V0ID0gXCJ1cGdyYWRlV2ViU29ja2V0XCIgaW4gaW5mb1xuICAgICAgPyBpbmZvLnVwZ3JhZGVXZWJTb2NrZXRcbiAgICAgIDogbWF5YmVVcGdyYWRlV2ViU29ja2V0O1xuICAgIHRoaXMuI3JlcXVlc3QgPSByZXF1ZXN0O1xuICAgIGNvbnN0IHsgcmVzb2x2ZSwgcmVqZWN0LCBwcm9taXNlIH0gPSBjcmVhdGVQcm9taXNlV2l0aFJlc29sdmVyczxSZXNwb25zZT4oKTtcbiAgICB0aGlzLiNyZXNvbHZlID0gcmVzb2x2ZTtcbiAgICB0aGlzLiNyZWplY3QgPSByZWplY3Q7XG4gICAgdGhpcy4jcmVzcG9uc2UgPSBwcm9taXNlO1xuICB9XG5cbiAgZ2V0IGJvZHkoKTogUmVhZGFibGVTdHJlYW08VWludDhBcnJheT4gfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy4jcmVxdWVzdC5ib2R5O1xuICB9XG5cbiAgZ2V0IGhlYWRlcnMoKTogSGVhZGVycyB7XG4gICAgcmV0dXJuIHRoaXMuI3JlcXVlc3QuaGVhZGVycztcbiAgfVxuXG4gIGdldCBtZXRob2QoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy4jcmVxdWVzdC5tZXRob2Q7XG4gIH1cblxuICBnZXQgcmVtb3RlQWRkcigpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLiNyZW1vdGVBZGRyPy5ob3N0bmFtZTtcbiAgfVxuXG4gIGdldCByZXF1ZXN0KCk6IFJlcXVlc3Qge1xuICAgIHJldHVybiB0aGlzLiNyZXF1ZXN0O1xuICB9XG5cbiAgZ2V0IHJlc3BvbnNlKCk6IFByb21pc2U8UmVzcG9uc2U+IHtcbiAgICByZXR1cm4gdGhpcy4jcmVzcG9uc2U7XG4gIH1cblxuICBnZXQgdXJsKCk6IHN0cmluZyB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHVybCA9IG5ldyBVUkwodGhpcy4jcmVxdWVzdC51cmwpO1xuICAgICAgcmV0dXJuIHRoaXMuI3JlcXVlc3QudXJsLnJlcGxhY2UodXJsLm9yaWdpbiwgXCJcIik7XG4gICAgfSBjYXRjaCB7XG4gICAgICAvLyB3ZSBkb24ndCBjYXJlIGFib3V0IGVycm9ycywgd2UganVzdCB3YW50IHRvIGZhbGwgYmFja1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy4jcmVxdWVzdC51cmw7XG4gIH1cblxuICBnZXQgcmF3VXJsKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuI3JlcXVlc3QudXJsO1xuICB9XG5cbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgZXJyb3IocmVhc29uPzogYW55KTogdm9pZCB7XG4gICAgaWYgKHRoaXMuI3Jlc29sdmVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJSZXF1ZXN0IGFscmVhZHkgcmVzcG9uZGVkIHRvLlwiKTtcbiAgICB9XG4gICAgdGhpcy4jcmVqZWN0KHJlYXNvbik7XG4gICAgdGhpcy4jcmVzb2x2ZWQgPSB0cnVlO1xuICB9XG5cbiAgZ2V0Qm9keSgpOiBSZWFkYWJsZVN0cmVhbTxVaW50OEFycmF5PiB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLiNyZXF1ZXN0LmJvZHk7XG4gIH1cblxuICByZXNwb25kKHJlc3BvbnNlOiBSZXNwb25zZSk6IHZvaWQge1xuICAgIGlmICh0aGlzLiNyZXNvbHZlZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUmVxdWVzdCBhbHJlYWR5IHJlc3BvbmRlZCB0by5cIik7XG4gICAgfVxuICAgIHRoaXMuI3Jlc29sdmVkID0gdHJ1ZTtcbiAgICB0aGlzLiNyZXNvbHZlKHJlc3BvbnNlKTtcbiAgfVxuXG4gIHVwZ3JhZGUob3B0aW9ucz86IFVwZ3JhZGVXZWJTb2NrZXRPcHRpb25zKTogV2ViU29ja2V0IHtcbiAgICBpZiAodGhpcy4jcmVzb2x2ZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIlJlcXVlc3QgYWxyZWFkeSByZXNwb25kZWQgdG8uXCIpO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuI3VwZ3JhZGVXZWJTb2NrZXQpIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJVcGdyYWRpbmcgd2ViIHNvY2tldHMgbm90IHN1cHBvcnRlZC5cIik7XG4gICAgfVxuICAgIGNvbnN0IHsgcmVzcG9uc2UsIHNvY2tldCB9ID0gdGhpcy4jdXBncmFkZVdlYlNvY2tldChcbiAgICAgIHRoaXMuI3JlcXVlc3QsXG4gICAgICBvcHRpb25zLFxuICAgICk7XG4gICAgdGhpcy4jcmVzb2x2ZShyZXNwb25zZSk7XG4gICAgdGhpcy4jcmVzb2x2ZWQgPSB0cnVlO1xuICAgIHJldHVybiBzb2NrZXQ7XG4gIH1cbn1cbiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSx5RUFBeUU7QUFRekUsU0FBUywwQkFBMEIsUUFBUSwyQ0FBMkM7QUFFdEYsbUNBQW1DO0FBQ25DLE9BQU8sTUFBTSxjQUErQixBQUFDLFdBQW1CLFFBQVEsSUFDdEUsTUFBTTtBQUFjLEVBQUU7QUFFeEIsTUFBTSx3QkFDSixVQUFVLGNBQWMsc0JBQXNCLFdBQVcsSUFBSSxHQUV6RCxBQUFDLEtBQWEsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFFBQ3BDO0FBRU4sT0FBTyxTQUFTLGdCQUFnQixDQUFnQjtFQUM5QyxPQUFPLGFBQWE7QUFDdEI7QUFPQTt1REFDdUQsR0FDdkQsT0FBTyxNQUFNO0VBQ1gsQ0FBQSxVQUFXLENBQVc7RUFDdEIsbUNBQW1DO0VBQ25DLENBQUEsTUFBTyxDQUF5QjtFQUNoQyxDQUFBLE9BQVEsQ0FBVTtFQUNsQixDQUFBLE9BQVEsQ0FBNEI7RUFDcEMsQ0FBQSxRQUFTLEdBQUcsTUFBTTtFQUNsQixDQUFBLFFBQVMsQ0FBb0I7RUFDN0IsQ0FBQSxnQkFBaUIsQ0FBc0I7RUFFdkMsWUFDRSxPQUFnQixFQUNoQixJQUF1QixDQUN2QjtJQUNBLElBQUksQ0FBQyxDQUFBLFVBQVcsR0FBRyxLQUFLLFVBQVU7SUFDbEMsc0VBQXNFO0lBQ3RFLElBQUksQ0FBQyxDQUFBLGdCQUFpQixHQUFHLHNCQUFzQixPQUMzQyxLQUFLLGdCQUFnQixHQUNyQjtJQUNKLElBQUksQ0FBQyxDQUFBLE9BQVEsR0FBRztJQUNoQixNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRztJQUNyQyxJQUFJLENBQUMsQ0FBQSxPQUFRLEdBQUc7SUFDaEIsSUFBSSxDQUFDLENBQUEsTUFBTyxHQUFHO0lBQ2YsSUFBSSxDQUFDLENBQUEsUUFBUyxHQUFHO0VBQ25CO0VBRUEsSUFBSSxPQUEwQztJQUM1QyxPQUFPLElBQUksQ0FBQyxDQUFBLE9BQVEsQ0FBQyxJQUFJO0VBQzNCO0VBRUEsSUFBSSxVQUFtQjtJQUNyQixPQUFPLElBQUksQ0FBQyxDQUFBLE9BQVEsQ0FBQyxPQUFPO0VBQzlCO0VBRUEsSUFBSSxTQUFpQjtJQUNuQixPQUFPLElBQUksQ0FBQyxDQUFBLE9BQVEsQ0FBQyxNQUFNO0VBQzdCO0VBRUEsSUFBSSxhQUFpQztJQUNuQyxPQUFPLElBQUksQ0FBQyxDQUFBLFVBQVcsRUFBRTtFQUMzQjtFQUVBLElBQUksVUFBbUI7SUFDckIsT0FBTyxJQUFJLENBQUMsQ0FBQSxPQUFRO0VBQ3RCO0VBRUEsSUFBSSxXQUE4QjtJQUNoQyxPQUFPLElBQUksQ0FBQyxDQUFBLFFBQVM7RUFDdkI7RUFFQSxJQUFJLE1BQWM7SUFDaEIsSUFBSTtNQUNGLE1BQU0sTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLENBQUEsT0FBUSxDQUFDLEdBQUc7TUFDckMsT0FBTyxJQUFJLENBQUMsQ0FBQSxPQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLE1BQU0sRUFBRTtJQUMvQyxFQUFFLE9BQU07SUFDTix3REFBd0Q7SUFDMUQ7SUFDQSxPQUFPLElBQUksQ0FBQyxDQUFBLE9BQVEsQ0FBQyxHQUFHO0VBQzFCO0VBRUEsSUFBSSxTQUFpQjtJQUNuQixPQUFPLElBQUksQ0FBQyxDQUFBLE9BQVEsQ0FBQyxHQUFHO0VBQzFCO0VBRUEsbUNBQW1DO0VBQ25DLE1BQU0sTUFBWSxFQUFRO0lBQ3hCLElBQUksSUFBSSxDQUFDLENBQUEsUUFBUyxFQUFFO01BQ2xCLE1BQU0sSUFBSSxNQUFNO0lBQ2xCO0lBQ0EsSUFBSSxDQUFDLENBQUEsTUFBTyxDQUFDO0lBQ2IsSUFBSSxDQUFDLENBQUEsUUFBUyxHQUFHO0VBQ25CO0VBRUEsVUFBNkM7SUFDM0MsT0FBTyxJQUFJLENBQUMsQ0FBQSxPQUFRLENBQUMsSUFBSTtFQUMzQjtFQUVBLFFBQVEsUUFBa0IsRUFBUTtJQUNoQyxJQUFJLElBQUksQ0FBQyxDQUFBLFFBQVMsRUFBRTtNQUNsQixNQUFNLElBQUksTUFBTTtJQUNsQjtJQUNBLElBQUksQ0FBQyxDQUFBLFFBQVMsR0FBRztJQUNqQixJQUFJLENBQUMsQ0FBQSxPQUFRLENBQUM7RUFDaEI7RUFFQSxRQUFRLE9BQWlDLEVBQWE7SUFDcEQsSUFBSSxJQUFJLENBQUMsQ0FBQSxRQUFTLEVBQUU7TUFDbEIsTUFBTSxJQUFJLE1BQU07SUFDbEI7SUFDQSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUEsZ0JBQWlCLEVBQUU7TUFDM0IsTUFBTSxJQUFJLFVBQVU7SUFDdEI7SUFDQSxNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFBLGdCQUFpQixDQUNqRCxJQUFJLENBQUMsQ0FBQSxPQUFRLEVBQ2I7SUFFRixJQUFJLENBQUMsQ0FBQSxPQUFRLENBQUM7SUFDZCxJQUFJLENBQUMsQ0FBQSxRQUFTLEdBQUc7SUFDakIsT0FBTztFQUNUO0FBQ0YifQ==
// denoCacheMetadata=8390793217482923630,13530066580276746893