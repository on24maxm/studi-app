// Copyright 2018-2025 the oak authors. All rights reserved. MIT license.
/** Middleware for oak that allows back-to-back proxies of requests to be
 * used.
 *
 * @module
 */ import { parseForwarded } from "../deps.ts";
import { isRouterContext } from "../utils/type_guards.ts";
function createMatcher({ match }) {
  return function matches(ctx) {
    if (!match) {
      return true;
    }
    if (typeof match === "string") {
      return ctx.request.url.pathname.startsWith(match);
    }
    if (match instanceof RegExp) {
      return match.test(ctx.request.url.pathname);
    }
    return match(ctx);
  };
}
async function createRequest(target, ctx, { headers: optHeaders, map, proxyHeaders = true, request: reqFn }) {
  let path = ctx.request.url.pathname;
  let params;
  if (isRouterContext(ctx)) {
    params = ctx.params;
  }
  if (map && typeof map === "function") {
    path = map(path, params);
  } else if (map) {
    path = map[path] ?? path;
  }
  const url = new URL(String(target));
  if (url.pathname.endsWith("/") && path.startsWith("/")) {
    url.pathname = `${url.pathname}${path.slice(1)}`;
  } else if (!url.pathname.endsWith("/") && !path.startsWith("/")) {
    url.pathname = `${url.pathname}/${path}`;
  } else {
    url.pathname = `${url.pathname}${path}`;
  }
  url.search = ctx.request.url.search;
  const body = await ctx.request.body?.init() ?? null;
  const headers = new Headers(ctx.request.headers);
  if (optHeaders) {
    if (typeof optHeaders === "function") {
      optHeaders = await optHeaders(ctx);
    }
    for (const [key, value] of iterableHeaders(optHeaders)){
      headers.set(key, value);
    }
  }
  if (proxyHeaders) {
    const maybeForwarded = headers.get("forwarded");
    const ip = ctx.request.ip.startsWith("[") ? `"${ctx.request.ip}"` : ctx.request.ip;
    const host = headers.get("host");
    if (maybeForwarded && parseForwarded(maybeForwarded)) {
      let value = `for=${ip}`;
      if (host) {
        value += `;host=${host}`;
      }
      headers.append("forwarded", value);
    } else {
      headers.append("x-forwarded-for", ip);
      if (host) {
        headers.append("x-forwarded-host", host);
      }
    }
  }
  const init = {
    body,
    headers,
    method: ctx.request.method,
    redirect: "follow"
  };
  let request = new Request(url.toString(), init);
  if (reqFn) {
    request = await reqFn(request);
  }
  return request;
}
function iterableHeaders(headers) {
  if (headers instanceof Headers) {
    return headers.entries();
  } else if (Array.isArray(headers)) {
    return headers.values();
  } else {
    return Object.entries(headers).values();
  }
}
async function processResponse(response, ctx, { contentType: contentTypeFn, response: resFn }) {
  if (resFn) {
    response = await resFn(response);
  }
  if (response.body) {
    ctx.response.body = response.body;
  } else {
    ctx.response.body = null;
  }
  ctx.response.status = response.status;
  for (const [key, value] of response.headers){
    ctx.response.headers.append(key, value);
  }
  if (contentTypeFn) {
    const value = await contentTypeFn(response.url, ctx.response.headers.get("content-type") ?? undefined);
    if (value != null) {
      ctx.response.headers.set("content-type", value);
    }
  }
}
export function proxy(target, options = {}) {
  const matches = createMatcher(options);
  return async function proxy(context, next) {
    if (!matches(context)) {
      return next();
    }
    const request = await createRequest(target, context, options);
    const { fetch = globalThis.fetch } = options;
    const response = await fetch(request, {
      context
    });
    await processResponse(response, context, options);
    return next();
  };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvb2FrQHYxNy4xLjYvbWlkZGxld2FyZS9wcm94eS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxOC0yMDI1IHRoZSBvYWsgYXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4gTUlUIGxpY2Vuc2UuXG5cbi8qKiBNaWRkbGV3YXJlIGZvciBvYWsgdGhhdCBhbGxvd3MgYmFjay10by1iYWNrIHByb3hpZXMgb2YgcmVxdWVzdHMgdG8gYmVcbiAqIHVzZWQuXG4gKlxuICogQG1vZHVsZVxuICovXG5cbmltcG9ydCB0eXBlIHsgU3RhdGUgfSBmcm9tIFwiLi4vYXBwbGljYXRpb24udHNcIjtcbmltcG9ydCB0eXBlIHsgQ29udGV4dCB9IGZyb20gXCIuLi9jb250ZXh0LnRzXCI7XG5pbXBvcnQgeyBwYXJzZUZvcndhcmRlZCB9IGZyb20gXCIuLi9kZXBzLnRzXCI7XG5pbXBvcnQgdHlwZSB7IE1pZGRsZXdhcmUgfSBmcm9tIFwiLi4vbWlkZGxld2FyZS50c1wiO1xuaW1wb3J0IHR5cGUge1xuICBSb3V0ZVBhcmFtcyxcbiAgUm91dGVyQ29udGV4dCxcbiAgUm91dGVyTWlkZGxld2FyZSxcbn0gZnJvbSBcIi4uL3JvdXRlci50c1wiO1xuaW1wb3J0IHsgaXNSb3V0ZXJDb250ZXh0IH0gZnJvbSBcIi4uL3V0aWxzL3R5cGVfZ3VhcmRzLnRzXCI7XG5cbnR5cGUgRmV0Y2ggPSAoXG4gIGlucHV0OiBSZXF1ZXN0LFxuICBpbml0OiB7IGNvbnRleHQ6IENvbnRleHQgfSxcbikgPT4gUHJvbWlzZTxSZXNwb25zZT47XG5cbnR5cGUgUHJveHlNYXRjaEZ1bmN0aW9uPFxuICBSIGV4dGVuZHMgc3RyaW5nLFxuICBQIGV4dGVuZHMgUm91dGVQYXJhbXM8Uj4gPSBSb3V0ZVBhcmFtczxSPixcbiAgLy8gZGVuby1saW50LWlnbm9yZSBuby1leHBsaWNpdC1hbnlcbiAgUyBleHRlbmRzIFN0YXRlID0gUmVjb3JkPHN0cmluZywgYW55Pixcbj4gPSAoY3R4OiBDb250ZXh0PFM+IHwgUm91dGVyQ29udGV4dDxSLCBQLCBTPikgPT4gYm9vbGVhbjtcblxudHlwZSBQcm94eU1hcEZ1bmN0aW9uPFIgZXh0ZW5kcyBzdHJpbmcsIFAgZXh0ZW5kcyBSb3V0ZVBhcmFtczxSPj4gPSAoXG4gIHBhdGg6IFIsXG4gIHBhcmFtcz86IFAsXG4pID0+IFI7XG5cbnR5cGUgUHJveHlIZWFkZXJzRnVuY3Rpb248UyBleHRlbmRzIFN0YXRlPiA9IChcbiAgY3R4OiBDb250ZXh0PFM+LFxuKSA9PiBIZWFkZXJzSW5pdCB8IFByb21pc2U8SGVhZGVyc0luaXQ+O1xuXG50eXBlIFByb3h5Um91dGVySGVhZGVyc0Z1bmN0aW9uPFxuICBSIGV4dGVuZHMgc3RyaW5nLFxuICBQIGV4dGVuZHMgUm91dGVQYXJhbXM8Uj4sXG4gIFMgZXh0ZW5kcyBTdGF0ZSxcbj4gPSAoY3R4OiBSb3V0ZXJDb250ZXh0PFIsIFAsIFM+KSA9PiBIZWFkZXJzSW5pdCB8IFByb21pc2U8SGVhZGVyc0luaXQ+O1xuXG4vKiogT3B0aW9ucyB3aGljaCBjYW4gYmUgc3BlY2lmaWVkIG9uIHRoZSB7QGxpbmtjb2RlIHByb3h5fSBtaWRkbGV3YXJlLiAqL1xuZXhwb3J0IGludGVyZmFjZSBQcm94eU9wdGlvbnM8XG4gIFIgZXh0ZW5kcyBzdHJpbmcsXG4gIFAgZXh0ZW5kcyBSb3V0ZVBhcmFtczxSPiA9IFJvdXRlUGFyYW1zPFI+LFxuICAvLyBkZW5vLWxpbnQtaWdub3JlIG5vLWV4cGxpY2l0LWFueVxuICBTIGV4dGVuZHMgU3RhdGUgPSBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuPiB7XG4gIC8qKiBBIGNhbGxiYWNrIGhvb2sgdGhhdCBpcyBjYWxsZWQgYWZ0ZXIgdGhlIHJlc3BvbnNlIGlzIHJlY2VpdmVkIHdoaWNoIGFsbG93c1xuICAgKiB0aGUgcmVzcG9uc2UgY29udGVudCB0eXBlIHRvIGJlIGFkanVzdGVkLiBUaGlzIGlzIGZvciBzaXR1YXRpb25zIHdoZXJlIHRoZVxuICAgKiBjb250ZW50IHR5cGUgcHJvdmlkZWQgYnkgdGhlIHByb3h5IHNlcnZlciBtaWdodCBub3QgYmUgc3VpdGFibGUgZm9yXG4gICAqIHJlc3BvbmRpbmcgd2l0aC4gKi9cbiAgY29udGVudFR5cGU/KFxuICAgIHVybDogc3RyaW5nLFxuICAgIGNvbnRlbnRUeXBlPzogc3RyaW5nLFxuICApOiBQcm9taXNlPHN0cmluZyB8IHVuZGVmaW5lZD4gfCBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIC8qKiBUaGUgZmV0Y2ggZnVuY3Rpb24gdG8gdXNlIHRvIHByb3h5IHRoZSByZXF1ZXN0LiBUaGlzIGRlZmF1bHRzIHRvIHRoZVxuICAgKiBnbG9iYWwge0BsaW5rY29kZSBmZXRjaH0gZnVuY3Rpb24uIEl0IHdpbGwgYWx3YXlzIGJlIGNhbGxlZCB3aXRoIGFcbiAgICogc2Vjb25kIGFyZ3VtZW50IHdoaWNoIGNvbnRhaW5zIGFuIG9iamVjdCBvZiBgeyBjb250ZXh0IH1gIHdoaWNoIHRoZVxuICAgKiBgY29udGV4dGAgcHJvcGVydHkgd2lsbCBiZSBhbiBpbnN0YW5jZSBvZiB7QGxpbmtjb2RlIFJvdXRlckNvbnRleHR9LlxuICAgKlxuICAgKiBUaGlzIGlzIGRlc2lnbmVkIGZvciBtb2NraW5nIHB1cnBvc2VzIG9yIGltcGxlbWVudGluZyBhIGBmZXRjaCgpYFxuICAgKiBjYWxsYmFjayB0aGF0IG5lZWRzIGFjY2VzcyB0aGUgY3VycmVudCBjb250ZXh0IHdoZW4gaXQgaXMgY2FsbGVkLiAqL1xuICBmZXRjaD86IEZldGNoO1xuICAvKiogQWRkaXRpb25hbCBoZWFkZXJzIHRoYXQgc2hvdWxkIGJlIHNldCBpbiB0aGUgcmVzcG9uc2UuIFRoZSB2YWx1ZSBjYW5cbiAgICogYmUgYSBoZWFkZXJzIGluaXQgdmFsdWUgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgb3IgcmVzb2x2ZXMgd2l0aCBhXG4gICAqIGhlYWRlcnMgaW5pdCB2YWx1ZS4gKi9cbiAgaGVhZGVycz86XG4gICAgfCBIZWFkZXJzSW5pdFxuICAgIHwgUHJveHlIZWFkZXJzRnVuY3Rpb248Uz5cbiAgICB8IFByb3h5Um91dGVySGVhZGVyc0Z1bmN0aW9uPFIsIFAsIFM+O1xuICAvKiogRWl0aGVyIGEgcmVjb3JkIG9yIGEgcHJveHkgbWFwIGZ1bmN0aW9uIHRoYXQgd2lsbCBhbGxvdyBwcm94aWVkIHJlcXVlc3RzXG4gICAqIGJlaW5nIGhhbmRsZWQgYnkgdGhlIG1pZGRsZXdhcmUgdG8gYmUgcmVtYXBwZWQgdG8gYSBkaWZmZXJlbnQgcmVtb3RlXG4gICAqIHBhdGguICovXG4gIG1hcD86IFJlY29yZDxzdHJpbmcsIFI+IHwgUHJveHlNYXBGdW5jdGlvbjxSLCBQPjtcbiAgLyoqIEEgc3RyaW5nLCByZWd1bGFyIGV4cHJlc3Npb24gb3IgcHJveHkgbWF0Y2ggZnVuY3Rpb24gd2hhdCBkZXRlcm1pbmVzIGlmXG4gICAqIHRoZSBwcm94eSBtaWRkbGV3YXJlIHNob3VsZCBwcm94eSB0aGUgcmVxdWVzdC5cbiAgICpcbiAgICogSWYgdGhlIHZhbHVlIGlzIGEgc3RyaW5nIHRoZSBtYXRjaCB3aWxsIGJlIHRydWUgaWYgdGhlIHJlcXVlc3RzIHBhdGhuYW1lXG4gICAqIHN0YXJ0cyB3aXRoIHRoZSBzdHJpbmcuIEluIHRoZSBjYXNlIG9mIGEgcmVndWxhciBleHByZXNzaW9uLCBpZiB0aGVcbiAgICogcGF0aG5hbWVcbiAgICovXG4gIG1hdGNoPzpcbiAgICB8IHN0cmluZ1xuICAgIHwgUmVnRXhwXG4gICAgfCBQcm94eU1hdGNoRnVuY3Rpb248UiwgUCwgUz47XG4gIC8qKiBBIGZsYWcgdGhhdCBpbmRpY2F0ZXMgaWYgdHJhZGl0aW9uYWwgcHJveHkgaGVhZGVycyBzaG91bGQgYmUgc2V0IGluIHRoZVxuICAgKiByZXNwb25zZS4gVGhpcyBkZWZhdWx0cyB0byBgdHJ1ZWAuXG4gICAqL1xuICBwcm94eUhlYWRlcnM/OiBib29sZWFuO1xuICAvKiogQSBjYWxsYmFjayBob29rIHdoaWNoIHdpbGwgYmUgY2FsbGVkIGJlZm9yZSBlYWNoIHByb3hpZWQgZmV0Y2ggcmVxdWVzdFxuICAgKiB0byBhbGxvdyB0aGUgbmF0aXZlIGBSZXF1ZXN0YCB0byBiZSBtb2RpZmllZCBvciByZXBsYWNlZC4gKi9cbiAgcmVxdWVzdD8ocmVxOiBSZXF1ZXN0KTogUmVxdWVzdCB8IFByb21pc2U8UmVxdWVzdD47XG4gIC8qKiBBIGNhbGxiYWNrIGhvb2sgd2hpY2ggd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgZWFjaCBwcm94aWVkIGZldGNoIHJlc3BvbnNlXG4gICAqIGlzIHJlY2VpdmVkIHRvIGFsbG93IHRoZSBuYXRpdmUgYFJlc3BvbnNlYCB0byBiZSBtb2RpZmllZCBvciByZXBsYWNlZC4gKi9cbiAgcmVzcG9uc2U/KHJlczogUmVzcG9uc2UpOiBSZXNwb25zZSB8IFByb21pc2U8UmVzcG9uc2U+O1xufVxuXG5mdW5jdGlvbiBjcmVhdGVNYXRjaGVyPFxuICBSIGV4dGVuZHMgc3RyaW5nLFxuICBQIGV4dGVuZHMgUm91dGVQYXJhbXM8Uj4sXG4gIFMgZXh0ZW5kcyBTdGF0ZSxcbj4oXG4gIHsgbWF0Y2ggfTogUHJveHlPcHRpb25zPFIsIFAsIFM+LFxuKSB7XG4gIHJldHVybiBmdW5jdGlvbiBtYXRjaGVzKGN0eDogUm91dGVyQ29udGV4dDxSLCBQLCBTPik6IGJvb2xlYW4ge1xuICAgIGlmICghbWF0Y2gpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIG1hdGNoID09PSBcInN0cmluZ1wiKSB7XG4gICAgICByZXR1cm4gY3R4LnJlcXVlc3QudXJsLnBhdGhuYW1lLnN0YXJ0c1dpdGgobWF0Y2gpO1xuICAgIH1cbiAgICBpZiAobWF0Y2ggaW5zdGFuY2VvZiBSZWdFeHApIHtcbiAgICAgIHJldHVybiBtYXRjaC50ZXN0KGN0eC5yZXF1ZXN0LnVybC5wYXRobmFtZSk7XG4gICAgfVxuICAgIHJldHVybiBtYXRjaChjdHgpO1xuICB9O1xufVxuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVSZXF1ZXN0PFxuICBSIGV4dGVuZHMgc3RyaW5nLFxuICBQIGV4dGVuZHMgUm91dGVQYXJhbXM8Uj4sXG4gIFMgZXh0ZW5kcyBTdGF0ZSxcbj4oXG4gIHRhcmdldDogc3RyaW5nIHwgVVJMLFxuICBjdHg6IENvbnRleHQ8Uz4gfCBSb3V0ZXJDb250ZXh0PFIsIFAsIFM+LFxuICB7IGhlYWRlcnM6IG9wdEhlYWRlcnMsIG1hcCwgcHJveHlIZWFkZXJzID0gdHJ1ZSwgcmVxdWVzdDogcmVxRm4gfTpcbiAgICBQcm94eU9wdGlvbnM8UiwgUCwgUz4sXG4pOiBQcm9taXNlPFJlcXVlc3Q+IHtcbiAgbGV0IHBhdGggPSBjdHgucmVxdWVzdC51cmwucGF0aG5hbWUgYXMgUjtcbiAgbGV0IHBhcmFtczogUCB8IHVuZGVmaW5lZDtcbiAgaWYgKGlzUm91dGVyQ29udGV4dDxSLCBQLCBTPihjdHgpKSB7XG4gICAgcGFyYW1zID0gY3R4LnBhcmFtcztcbiAgfVxuICBpZiAobWFwICYmIHR5cGVvZiBtYXAgPT09IFwiZnVuY3Rpb25cIikge1xuICAgIHBhdGggPSBtYXAocGF0aCwgcGFyYW1zKTtcbiAgfSBlbHNlIGlmIChtYXApIHtcbiAgICBwYXRoID0gbWFwW3BhdGhdID8/IHBhdGg7XG4gIH1cbiAgY29uc3QgdXJsID0gbmV3IFVSTChTdHJpbmcodGFyZ2V0KSk7XG4gIGlmICh1cmwucGF0aG5hbWUuZW5kc1dpdGgoXCIvXCIpICYmIHBhdGguc3RhcnRzV2l0aChcIi9cIikpIHtcbiAgICB1cmwucGF0aG5hbWUgPSBgJHt1cmwucGF0aG5hbWV9JHtwYXRoLnNsaWNlKDEpfWA7XG4gIH0gZWxzZSBpZiAoIXVybC5wYXRobmFtZS5lbmRzV2l0aChcIi9cIikgJiYgIXBhdGguc3RhcnRzV2l0aChcIi9cIikpIHtcbiAgICB1cmwucGF0aG5hbWUgPSBgJHt1cmwucGF0aG5hbWV9LyR7cGF0aH1gO1xuICB9IGVsc2Uge1xuICAgIHVybC5wYXRobmFtZSA9IGAke3VybC5wYXRobmFtZX0ke3BhdGh9YDtcbiAgfVxuICB1cmwuc2VhcmNoID0gY3R4LnJlcXVlc3QudXJsLnNlYXJjaDtcblxuICBjb25zdCBib2R5ID0gYXdhaXQgY3R4LnJlcXVlc3QuYm9keT8uaW5pdCgpID8/IG51bGw7XG4gIGNvbnN0IGhlYWRlcnMgPSBuZXcgSGVhZGVycyhjdHgucmVxdWVzdC5oZWFkZXJzKTtcbiAgaWYgKG9wdEhlYWRlcnMpIHtcbiAgICBpZiAodHlwZW9mIG9wdEhlYWRlcnMgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgb3B0SGVhZGVycyA9IGF3YWl0IG9wdEhlYWRlcnMoY3R4IGFzIFJvdXRlckNvbnRleHQ8UiwgUCwgUz4pO1xuICAgIH1cbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBpdGVyYWJsZUhlYWRlcnMob3B0SGVhZGVycykpIHtcbiAgICAgIGhlYWRlcnMuc2V0KGtleSwgdmFsdWUpO1xuICAgIH1cbiAgfVxuICBpZiAocHJveHlIZWFkZXJzKSB7XG4gICAgY29uc3QgbWF5YmVGb3J3YXJkZWQgPSBoZWFkZXJzLmdldChcImZvcndhcmRlZFwiKTtcbiAgICBjb25zdCBpcCA9IGN0eC5yZXF1ZXN0LmlwLnN0YXJ0c1dpdGgoXCJbXCIpXG4gICAgICA/IGBcIiR7Y3R4LnJlcXVlc3QuaXB9XCJgXG4gICAgICA6IGN0eC5yZXF1ZXN0LmlwO1xuICAgIGNvbnN0IGhvc3QgPSBoZWFkZXJzLmdldChcImhvc3RcIik7XG4gICAgaWYgKG1heWJlRm9yd2FyZGVkICYmIHBhcnNlRm9yd2FyZGVkKG1heWJlRm9yd2FyZGVkKSkge1xuICAgICAgbGV0IHZhbHVlID0gYGZvcj0ke2lwfWA7XG4gICAgICBpZiAoaG9zdCkge1xuICAgICAgICB2YWx1ZSArPSBgO2hvc3Q9JHtob3N0fWA7XG4gICAgICB9XG4gICAgICBoZWFkZXJzLmFwcGVuZChcImZvcndhcmRlZFwiLCB2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGhlYWRlcnMuYXBwZW5kKFwieC1mb3J3YXJkZWQtZm9yXCIsIGlwKTtcbiAgICAgIGlmIChob3N0KSB7XG4gICAgICAgIGhlYWRlcnMuYXBwZW5kKFwieC1mb3J3YXJkZWQtaG9zdFwiLCBob3N0KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjb25zdCBpbml0OiBSZXF1ZXN0SW5pdCA9IHtcbiAgICBib2R5LFxuICAgIGhlYWRlcnMsXG4gICAgbWV0aG9kOiBjdHgucmVxdWVzdC5tZXRob2QsXG4gICAgcmVkaXJlY3Q6IFwiZm9sbG93XCIsXG4gIH07XG4gIGxldCByZXF1ZXN0ID0gbmV3IFJlcXVlc3QodXJsLnRvU3RyaW5nKCksIGluaXQpO1xuICBpZiAocmVxRm4pIHtcbiAgICByZXF1ZXN0ID0gYXdhaXQgcmVxRm4ocmVxdWVzdCk7XG4gIH1cbiAgcmV0dXJuIHJlcXVlc3Q7XG59XG5cbmZ1bmN0aW9uIGl0ZXJhYmxlSGVhZGVycyhcbiAgaGVhZGVyczogSGVhZGVyc0luaXQsXG4pOiBJdGVyYWJsZUl0ZXJhdG9yPFtzdHJpbmcsIHN0cmluZ10+IHtcbiAgaWYgKGhlYWRlcnMgaW5zdGFuY2VvZiBIZWFkZXJzKSB7XG4gICAgcmV0dXJuIGhlYWRlcnMuZW50cmllcygpO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoaGVhZGVycykpIHtcbiAgICByZXR1cm4gaGVhZGVycy52YWx1ZXMoKSBhcyBJdGVyYWJsZUl0ZXJhdG9yPFtzdHJpbmcsIHN0cmluZ10+O1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBPYmplY3QuZW50cmllcyhoZWFkZXJzKS52YWx1ZXMoKSBhcyBJdGVyYWJsZUl0ZXJhdG9yPFxuICAgICAgW3N0cmluZywgc3RyaW5nXVxuICAgID47XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJvY2Vzc1Jlc3BvbnNlPFxuICBSIGV4dGVuZHMgc3RyaW5nLFxuICBQIGV4dGVuZHMgUm91dGVQYXJhbXM8Uj4sXG4gIFMgZXh0ZW5kcyBTdGF0ZSxcbj4oXG4gIHJlc3BvbnNlOiBSZXNwb25zZSxcbiAgY3R4OiBDb250ZXh0PFM+IHwgUm91dGVyQ29udGV4dDxSLCBQLCBTPixcbiAgeyBjb250ZW50VHlwZTogY29udGVudFR5cGVGbiwgcmVzcG9uc2U6IHJlc0ZuIH06IFByb3h5T3B0aW9uczxSLCBQLCBTPixcbikge1xuICBpZiAocmVzRm4pIHtcbiAgICByZXNwb25zZSA9IGF3YWl0IHJlc0ZuKHJlc3BvbnNlKTtcbiAgfVxuICBpZiAocmVzcG9uc2UuYm9keSkge1xuICAgIGN0eC5yZXNwb25zZS5ib2R5ID0gcmVzcG9uc2UuYm9keTtcbiAgfSBlbHNlIHtcbiAgICBjdHgucmVzcG9uc2UuYm9keSA9IG51bGw7XG4gIH1cbiAgY3R4LnJlc3BvbnNlLnN0YXR1cyA9IHJlc3BvbnNlLnN0YXR1cztcbiAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgcmVzcG9uc2UuaGVhZGVycykge1xuICAgIGN0eC5yZXNwb25zZS5oZWFkZXJzLmFwcGVuZChrZXksIHZhbHVlKTtcbiAgfVxuICBpZiAoY29udGVudFR5cGVGbikge1xuICAgIGNvbnN0IHZhbHVlID0gYXdhaXQgY29udGVudFR5cGVGbihcbiAgICAgIHJlc3BvbnNlLnVybCxcbiAgICAgIGN0eC5yZXNwb25zZS5oZWFkZXJzLmdldChcImNvbnRlbnQtdHlwZVwiKSA/PyB1bmRlZmluZWQsXG4gICAgKTtcbiAgICBpZiAodmFsdWUgIT0gbnVsbCkge1xuICAgICAgY3R4LnJlc3BvbnNlLmhlYWRlcnMuc2V0KFwiY29udGVudC10eXBlXCIsIHZhbHVlKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBNaWRkbGV3YXJlIHRoYXQgcHJvdmlkZXMgYSBiYWNrLXRvLWJhY2sgcHJveHkgZm9yIHJlcXVlc3RzLlxuICpcbiAqIEBwYXJhbSB0YXJnZXRcbiAqIEBwYXJhbSBvcHRpb25zXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBwcm94eTxTIGV4dGVuZHMgU3RhdGU+KFxuICB0YXJnZXQ6IHN0cmluZyB8IFVSTCxcbiAgb3B0aW9ucz86IFByb3h5T3B0aW9uczxzdHJpbmcsIFJvdXRlUGFyYW1zPHN0cmluZz4sIFM+LFxuKTogTWlkZGxld2FyZTxTPjtcbmV4cG9ydCBmdW5jdGlvbiBwcm94eTxcbiAgUiBleHRlbmRzIHN0cmluZyxcbiAgUCBleHRlbmRzIFJvdXRlUGFyYW1zPFI+LFxuICBTIGV4dGVuZHMgU3RhdGUsXG4+KFxuICB0YXJnZXQ6IHN0cmluZyB8IFVSTCxcbiAgb3B0aW9uczogUHJveHlPcHRpb25zPFIsIFAsIFM+ID0ge30sXG4pOiBSb3V0ZXJNaWRkbGV3YXJlPFIsIFAsIFM+IHtcbiAgY29uc3QgbWF0Y2hlcyA9IGNyZWF0ZU1hdGNoZXIob3B0aW9ucyk7XG4gIHJldHVybiBhc3luYyBmdW5jdGlvbiBwcm94eShjb250ZXh0LCBuZXh0KSB7XG4gICAgaWYgKCFtYXRjaGVzKGNvbnRleHQpKSB7XG4gICAgICByZXR1cm4gbmV4dCgpO1xuICAgIH1cbiAgICBjb25zdCByZXF1ZXN0ID0gYXdhaXQgY3JlYXRlUmVxdWVzdCh0YXJnZXQsIGNvbnRleHQsIG9wdGlvbnMpO1xuICAgIGNvbnN0IHsgZmV0Y2ggPSBnbG9iYWxUaGlzLmZldGNoIH0gPSBvcHRpb25zO1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2gocmVxdWVzdCwgeyBjb250ZXh0IH0pO1xuICAgIGF3YWl0IHByb2Nlc3NSZXNwb25zZShyZXNwb25zZSwgY29udGV4dCwgb3B0aW9ucyk7XG4gICAgcmV0dXJuIG5leHQoKTtcbiAgfTtcbn1cbiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSx5RUFBeUU7QUFFekU7Ozs7Q0FJQyxHQUlELFNBQVMsY0FBYyxRQUFRLGFBQWE7QUFPNUMsU0FBUyxlQUFlLFFBQVEsMEJBQTBCO0FBc0YxRCxTQUFTLGNBS1AsRUFBRSxLQUFLLEVBQXlCO0VBRWhDLE9BQU8sU0FBUyxRQUFRLEdBQTJCO0lBQ2pELElBQUksQ0FBQyxPQUFPO01BQ1YsT0FBTztJQUNUO0lBQ0EsSUFBSSxPQUFPLFVBQVUsVUFBVTtNQUM3QixPQUFPLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDO0lBQzdDO0lBQ0EsSUFBSSxpQkFBaUIs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
// denoCacheMetadata=14153327789349026468,1920388660235505944