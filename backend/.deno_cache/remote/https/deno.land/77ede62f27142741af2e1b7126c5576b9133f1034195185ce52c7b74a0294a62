/*!
 * Adapted directly from https://github.com/pillarjs/resolve-path
 * which is licensed as follows:
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2014 Jonathan Ong <me@jongleberry.com>
 * Copyright (c) 2015-2018 Douglas Christopher Wilson <doug@somethingdoug.com>
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * 'Software'), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED 'AS IS', WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
 * CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
 * TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
 * SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

import {
  createHttpError,
  isAbsolute,
  join,
  normalize,
  SEPARATOR,
} from "../deps.ts";

const UP_PATH_REGEXP = /(?:^|[\\/])\.\.(?:[\\/]|$)/;

export function resolvePath(relativePath: string): string;
export function resolvePath(rootPath: string, relativePath: string): string;
export function resolvePath(rootPath: string, relativePath?: string): string {
  let path = relativePath;
  let root = rootPath;

  // root is optional, similar to root.resolve
  if (relativePath === undefined) {
    path = rootPath;
    root = ".";
  }

  if (path == null) {
    throw new TypeError("Argument relativePath is required.");
  }

  // containing NULL bytes is malicious
  if (path.includes("\0")) {
    throw createHttpError(400, "Malicious Path");
  }

  // path should never be absolute
  if (isAbsolute(path)) {
    throw createHttpError(400, "Malicious Path");
  }

  // path outside root
  if (UP_PATH_REGEXP.test(normalize(`.${SEPARATOR}${path}`))) {
    throw createHttpError(403);
  }

  // join the relative path
  return normalize(join(root, path));
}

// denoCacheMetadata={"headers":{"x-amz-server-side-encryption":"AES256","referrer-policy":"strict-origin-when-cross-origin","access-control-allow-origin":"*","date":"Fri, 15 Aug 2025 01:33:24 GMT","cross-origin-embedder-policy":"same-origin","cross-origin-resource-policy":"same-origin","x-amz-cf-pop":"FRA56-P5","server-timing":"fetchSource;dur=8","vary":"Accept-Encoding, Origin","server":"deno/gcp-europe-west3","x-amz-replication-status":"COMPLETED","age":"7046126","content-type":"application/typescript; charset=utf-8","x-frame-options":"DENY","cross-origin-opener-policy":"same-origin","strict-transport-security":"max-age=63072000; includeSubDomains; preload","accept-ranges":"bytes","content-security-policy":"default-src 'none'; style-src 'unsafe-inline'; sandbox","content-length":"2417","x-amz-cf-id":"G5vFsIRGtEPHkXLffMX5zc_xVlu1e1HeFmd9EH50Gx8ofd2ZD6Ru-Q==","via":"http/2 edgeproxy-h","etag":"\"ca756a74e48e7ae36d0b93d2247e4de2\"","x-amz-version-id":"SRHt194CgNrZ1OeBrJ_zyxDo0szUDcqP","last-modified":"Fri, 08 Aug 2025 23:08:39 GMT","x-cache":"Hit from cloudfront","x-content-type-options":"nosniff","cache-control":"public, max-age=31536000, immutable"},"url":"https://deno.land/x/oak@v17.1.6/utils/resolve_path.ts","time":1762267729}