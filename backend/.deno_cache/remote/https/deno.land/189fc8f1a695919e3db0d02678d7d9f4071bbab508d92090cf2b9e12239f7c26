// Copyright 2018-2025 the oak authors. All rights reserved. MIT license.

/** The abstraction that oak uses when dealing with requests and responses
 * within the Deno runtime.
 *
 * @module
 */

import type { Application, State } from "./application.ts";
import { NativeRequest } from "./http_server_native_request.ts";
import type {
  HttpServer,
  Listener,
  OakServer,
  ServeInit,
  ServeOptions,
  ServeTlsOptions,
} from "./types.ts";
import { createPromiseWithResolvers } from "./utils/create_promise_with_resolvers.ts";

const serve:
  | ((
    options: ServeInit & (ServeOptions | ServeTlsOptions),
  ) => HttpServer)
  | undefined = "Deno" in globalThis && "serve" in globalThis.Deno
    ? globalThis.Deno.serve.bind(globalThis.Deno)
    : undefined;

/** The oak abstraction of the Deno native HTTP server which is used internally
 * for handling native HTTP requests. Generally users of oak do not need to
 * worry about this class. */
// deno-lint-ignore no-explicit-any
export class Server<AS extends State = Record<string, any>>
  implements OakServer<NativeRequest> {
  #app: Application<AS>;
  #closed = false;
  #httpServer?: HttpServer;
  #options: ServeOptions | ServeTlsOptions;
  #stream?: ReadableStream<NativeRequest>;

  constructor(
    app: Application<AS>,
    options: Omit<ServeOptions | ServeTlsOptions, "signal">,
  ) {
    if (!serve) {
      throw new Error(
        "The native bindings for serving HTTP are not available.",
      );
    }
    this.#app = app;
    this.#options = options;
  }

  get app(): Application<AS> {
    return this.#app;
  }

  get closed(): boolean {
    return this.#closed;
  }

  async close(): Promise<void> {
    if (this.#closed) {
      return;
    }

    if (this.#httpServer) {
      this.#httpServer.unref();
      await this.#httpServer.shutdown();
      this.#httpServer = undefined;
    }
    this.#closed = true;
  }

  listen(): Promise<Listener> {
    if (this.#httpServer) {
      throw new Error("Server already listening.");
    }
    const { signal } = this.#options;
    const { onListen, ...options } = this.#options;
    const { promise, resolve } = createPromiseWithResolvers<Listener>();
    this.#stream = new ReadableStream<NativeRequest>({
      start: (controller) => {
        this.#httpServer = serve?.({
          handler: (req, info) => {
            const nativeRequest = new NativeRequest(req, info);
            controller.enqueue(nativeRequest);
            return nativeRequest.response;
          },
          onListen({ hostname, port }) {
            if (onListen) {
              onListen({ hostname, port });
            }
            resolve({ addr: { hostname, port } });
          },
          signal,
          ...options,
        });
      },
    });

    signal?.addEventListener("abort", () => this.close(), { once: true });
    return promise;
  }

  [Symbol.asyncIterator](): AsyncIterableIterator<NativeRequest> {
    if (!this.#stream) {
      throw new TypeError("Server hasn't started listening.");
    }
    return this.#stream[Symbol.asyncIterator]();
  }

  static type: "native" = "native";
}

// denoCacheMetadata={"headers":{"x-amz-version-id":"MX3sPSl0BzyU9UokFGmqOQL3qNUeSX5W","cross-origin-embedder-policy":"same-origin","age":"7573203","x-amz-cf-id":"njVXFzdcSQ1J4CGZmvszHgH7FOCCwyQmMu27h2e305M7MdTLCIRCYg==","x-cache":"Hit from cloudfront","cross-origin-resource-policy":"same-origin","accept-ranges":"bytes","content-security-policy":"default-src 'none'; style-src 'unsafe-inline'; sandbox","referrer-policy":"strict-origin-when-cross-origin","server":"deno/gcp-europe-west3","content-length":"3119","cache-control":"public, max-age=31536000, immutable","server-timing":"fetchSource;dur=4","x-amz-cf-pop":"FRA56-P5","strict-transport-security":"max-age=63072000; includeSubDomains; preload","x-amz-replication-status":"PENDING","x-amz-server-side-encryption":"AES256","x-content-type-options":"nosniff","cross-origin-opener-policy":"same-origin","etag":"\"fa3cdfdedf339f5fecd95f712a8ce844\"","content-type":"application/typescript; charset=utf-8","vary":"Accept-Encoding, Origin","last-modified":"Fri, 08 Aug 2025 23:08:39 GMT","x-frame-options":"DENY","date":"Fri, 08 Aug 2025 23:08:45 GMT","via":"http/2 edgeproxy-h","access-control-allow-origin":"*"},"url":"https://deno.land/x/oak@v17.1.6/http_server_native.ts","time":1762267728}